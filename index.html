<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Trello Kanban – Chatwoot Dashboard App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f4f5fb;
      --border: #d3d6e4;
      --text: #1f2933;
      --muted: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    .header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      background: #ffffffdd;
      backdrop-filter: blur(6px);
    }

    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .title {
      font-size: 14px;
      font-weight: 600;
    }

    .subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .info-bar {
      font-size: 11px;
      color: var(--muted);
      padding: 4px 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      gap: 4px;
      background: #fafbff;
    }

    .info-bar span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .loading {
      font-size: 12px;
      color: var(--muted);
      padding: 8px 10px;
    }

    iframe {
      border: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="header">
      <span class="badge">Trello</span>
      <div>
        <div class="title">Kanban de Atendimento</div>
        <div class="subtitle">Visualização do Trello via n8n dentro do Chatwoot</div>
      </div>
    </header>

    <div class="content">
      <div class="info-bar">
        <span id="info-left">Aguardando contexto da conversa…</span>
        <span id="info-right"></span>
      </div>

      <div class="loading" id="loadingMsg">
        Carregando board do Trello…
      </div>

      <iframe
        id="trelloFrame"
        src="about:blank"
        allowtransparency="true"
        title="Trello Kanban"
      ></iframe>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURAÇÃO – AJUSTE AQUI
    // ============================================

    // URL base do seu n8n (sem barra no final)
    // Exemplo: "https://n8n.seudominio.com" ou "https://seu-servidor.com/n8n"
    const N8N_BASE_URL = "https://workflows.rnztech.com";

    // Endpoint do proxy de kanban no n8n (Workflow: Trello Proxy Kanban)
    const PROXY_ENDPOINT = "/webhook/trello/proxy";

    // ============================================
    // LÓGICA DO APP
    // ============================================

    const infoLeftEl = document.getElementById("info-left");
    const infoRightEl = document.getElementById("info-right");
    const loadingEl = document.getElementById("loadingMsg");
    const iframeEl = document.getElementById("trelloFrame");

    function buildProxyUrl(queue, conversationId, contactName) {
      const params = new URLSearchParams();
      if (queue) params.set("queue", queue);
      if (conversationId) params.set("conversationId", conversationId);
      if (contactName) params.set("contactName", contactName);

      // Gera algo como:
      // https://workflows.rnztech.com/webhook/trello/proxy?queue=default&conversationId=123&contactName=Joao
      return N8N_BASE_URL.replace(/\/$/, "") + PROXY_ENDPOINT + "?" + params.toString();
    }

    function chooseIframeUrl(appContext) {
      const conversation = appContext?.conversation || {};
      const contact = appContext?.contact || {};
      const custom = conversation.custom_attributes || {};
      const filaState = custom.fila_state || {};

      // Fila padrão se não tiver nada salvo
      const queue = filaState.queue || custom.queue || "default";
      const conversationId = conversation.id || "";
      const contactName = contact.name || contact.identifier || "Cliente sem nome";

      return buildProxyUrl(queue, conversationId, contactName);
    }

    function renderInfo(appContext, iframeUrl) {
      const conversation = appContext?.conversation || {};
      const contact = appContext?.contact || {};
      const custom = conversation.custom_attributes || {};
      const filaState = custom.fila_state || {};

      const contactName = contact.name || contact.identifier || "Cliente sem nome";
      const convId = conversation.id ? `Conv. #${conversation.id}` : "";
      const fila = filaState.queue || custom.queue || "default";

      infoLeftEl.textContent = `${contactName} ${convId ? "• " + convId : ""}`;
      infoRightEl.textContent = `Fila: ${fila}`;

      loadingEl.style.display = "none";
      iframeEl.src = iframeUrl;
    }

    function handleAppContext(appContext) {
      const iframeUrl = chooseIframeUrl(appContext);
      renderInfo(appContext, iframeUrl);
    }

    // Listener para receber o contexto do Chatwoot
    window.addEventListener("message", function (event) {
      try {
        if (typeof event.data !== "string") return;
        const payload = JSON.parse(event.data);

        if (payload.event === "appContext") {
          handleAppContext(payload.data);
        }
      } catch (e) {
        console.error("Erro ao processar mensagem do Chatwoot:", e);
      }
    });

    // Solicita o contexto explicitamente ao Chatwoot
    // (padrão dos Dashboard Apps)
    try {
      window.parent?.postMessage("chatwoot-dashboard-app:fetch-info", "*");
    } catch (e) {
      console.error("Erro ao solicitar contexto ao Chatwoot:", e);
    }
  </script>
</body>
</html>
